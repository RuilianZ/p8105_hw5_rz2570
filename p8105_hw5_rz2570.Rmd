---
title: "p8105_hw5"
author: "Ruilian Zhang"
date: "11/12/2021"
output: github_document
---

```{r}
library(tidyverse)
```


## Problem 1

```{r import and summary data}
homicide_df = read_csv("data/homicide-data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(city_state = str_c(city, state, sep = ", "))

n_homicides_df = homicide_df %>% 
  group_by(city_state) %>% 
  summarize(
    n_homicides = n()
  )

n_unsolved_df = homicide_df %>% 
  group_by(city_state) %>% 
  filter(disposition %in% c("Closed without arrest", "Open/No arrest")) %>% 
  summarize(
    n_unsolved = n()
  )

city_summary_df = left_join(n_homicides_df, n_unsolved_df, by = "city_state") %>% 
  mutate(n_unsolved = replace_na(n_unsolved, 0))

knitr::kable(city_summary_df)
```

```{r prop test baltimore}
baltimore_prop = prop.test(x = 1825, n = 2827, alternative = "two.sided")

baltimore_prop_tidy = broom::tidy(baltimore_prop, conf.int = TRUE)

pull(baltimore_prop_tidy, estimate)
c(pull(baltimore_prop_tidy, conf.low), pull(baltimore_prop_tidy, conf.high))
```

* For unsolved homicides in Baltimore, the estimated proportion is `r pull(baltimore_prop_tidy, estimate)`. The confidence interval is (`r c(pull(baltimore_prop_tidy, conf.low), pull(baltimore_prop_tidy, conf.high))`).

```{r proptest each city}
city_summary_nested = nest(city_summary_df, data = c("n_homicides", "n_unsolved"))

city_prop = function(df) {
  
  n = df[[1]]
  x = df[[2]]
  
  prop_test = prop.test(x = x, n = n, alternative = "two.sided") %>% 
    broom::tidy(conf.int = TRUE)
  
  tibble(
    est_unsolved_prop = round(pull(prop_test, estimate), 2),
    conf_int_lower = round(pull(prop_test, conf.low), 2),
    conf_int_upper = round(pull(prop_test, conf.high), 2)
    )
    
  }

city_prop_df = city_summary_nested %>% 
  mutate(prop_results = map(data, city_prop)) %>% 
  unnest(prop_results) %>% 
  select(-data)

knitr::kable(city_prop_df)
```

```{r plot esitimaes and CIs}
city_prop_df %>% 
  ggplot(aes(x = reorder(city_state, est_unsolved_prop), y = est_unsolved_prop)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf_int_lower, ymax = conf_int_upper)) + 
  coord_flip() +
  labs(
    title = "Estimated proportion of unsolved homicide for each city",
    y = "Estimated proportion",
    x = "City",
    caption = "Error bar shows 95% confidence interval"
  )
```

* The plot shows the estimated proportion of unsolved homicide for each city, in which the cities are ordered by estimated proportions.  
* `Tulsa, AL` has the lowest proportion of 0. `Chicago, IL` has the highest proportion. 
